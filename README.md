# StegoMark

为 Typecho 提供隐形水印、访客指纹与泄露溯源的内容版权保护插件。

- 作者：寒士杰克
- 网站：www.hansjack.com
- 协议：GPL-3.0（见 `LICENSE`）

https://github.com/TGU-HansJack/StegoMark

## 功能概览

- 隐形水印
  - 零宽字符水印（复制粘贴可保留）
  - HTML 注释水印（`<!--SM:...-->`）作为冗余层
  - 每篇文章唯一 Watermark ID（WMID）+ 全站 Site Fingerprint
- 访客溯源
  - 访客指纹（Visitor ID）注入水印载荷
  - 登录用户信息（如登录）可写入载荷并在后台解码展示
- 复制保护
  - 复制自动追加版权信息（支持模板变量）
  - 复制时会将一段隐藏水印注入到“复制正文”中，避免用户删除可见版权尾巴后导致解码失败
- SEO/兼容
  - 搜索引擎无水印模式（UA 白名单）
  - API/Feed 无水印模式
- 视觉微水印（防截图取证）
  - 背景 SVG 平铺层、噪点纹理层、Canvas 微字/图案层
  - 每层可单独设置透明度，多层同时启用会自动按层数均摊，避免越叠越黑
- 管理与分析
  - 后台解码工具（粘贴文本/HTML 解码）
  - 日志中心（访问/复制/解码/告警）
  - 批量文章 Watermark ID 重建
  - 站点版权证书信息（Site Fingerprint + Certificate ID）

## 安装

1. 将整个插件目录放到：`usr/plugins/StegoMark`
2. Typecho 后台启用插件：控制台 -> 插件 -> `StegoMark`

## 快速开始

1. 保持默认开启：字符水印 + 注释水印 + 视觉层
2. 打开一篇文章页，复制任意一段文字到本地记事本（不要用会“清洗零宽字符”的平台）
3. 后台进入 `StegoMark` 管理页，把粘贴内容放入“水印解码工具”解析

## 配置项说明（核心）

（建议截图：后台插件设置页完整截图。截图类型：后台页面截图，PNG。）

- 总开关
  - `总开关`：全站启用/关闭
  - `仅对文章页启用`：只在 `post` 单页生效（更稳）
- 水印强度与密度
  - `水印强度`：弱/中/强（影响最少注入次数）
  - `插入比例 insertRatio`：越大越密（建议从 `0.08` 开始逐步加）
  - `分布策略`：段落随机 / 句子优先 / 完全随机
  - `动态注入`：前端再注入一轮（更强，但也更容易“肉眼可感知”）
- 算法组合
  - `字符水印`：零宽字符（主要层）
  - `注释水印`：HTML 注释（冗余层）
  - `CSS/视觉水印层`：视觉微水印（截图取证层）
- 视觉微水印透明度
  - `背景水印透明度`、`噪点纹理透明度`、`Canvas 层透明度`
  - 建议范围：`0.005 ~ 0.05`，多层叠加请更低
- 访问控制（防屏蔽）
  - `无法生成指纹则遮罩封禁`：文章页默认遮罩，需前端 JS 正常运行并生成指纹后解除

（建议截图：前台文章页“遮罩封禁”效果。截图类型：前台页面截图，PNG。）

## 模板变量

复制追加模板、前端自定义布局 HTML 都支持变量替换：

- `{title}` `{url}` `{site}` `{user}`
- `{watermark_id}` `{site_fingerprint}` `{visitor_id}`
- `{time}`

示例（复制追加模板）：

```text
来源：{url}
版权：© {site} 保留所有权利
水印ID：{watermark_id}
```

示例（自定义布局 HTML）：

```html
<aside class="sm-copyright">
  <div>本文链接：<a href="{url}">{title}</a></div>
  <div>版权：© {site}，转载请注明出处</div>
  <div class="sm-meta">WMID: {watermark_id}</div>
</aside>
```

## 后台解码工具

入口：`extending.php?panel=StegoMark/manage.php`

支持从以下内容解码：

- 复制后的纯文本（零宽字符层）
- HTML 源码（零宽字符层 + 注释层 + CSS 层 `data-sm-token`）

如果你发现“删掉可见版权尾巴”会导致解码失败：

- v1.0.2+ 已在复制时把隐藏水印注入到复制正文里，正常不应受影响
- 若仍失败，多半是粘贴目标平台清洗了零宽字符：请换用本地纯文本编辑器，或直接粘贴页面 HTML 源码再解码

## 视觉微水印（不重合建议）

视觉层会叠加渲染，多层同时开启时建议遵循：

- 只保留 1 个“文字承载层”（背景 SVG 或 Canvas 二选一），另一个用作纹理/图案或关闭
- 先调低透明度再开启多层，避免“肉眼可见”

Canvas 层的微字用于“截图后增强对比取证”，不是自动识别。

## 日志中心与重建

- 日志中心：访问/复制/解码/告警
- 批量重建：为历史文章生成/更新 Watermark ID（支持强制覆盖）